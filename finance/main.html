<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App</title>
    <style>
        *{
            box-sizing: border-box;
            font-size: 14px;
        }
        .item{
            padding-left: 18px;
        }
        #data{
            display: flex;
        }
        #data>.wrapper{
            flex: 0 0 500px;
            margin-right:10px;
        }
        #data>.wrapper>.report{
            margin-bottom: 10px;
        }
        #data>.wrapper>.report>.title{
            height: 24px;
            padding: 4px;
            background-color: #BCD4E6;
            color: #555;
            font-size: 16px;
            font-weight: bold;
        }
        #data>.wrapper>.report>.title[data-report-warn=true]{
            background-color: #FFCCFF;
        }
        #data>.wrapper>.report>.content .item{
            border-left:1px solid #CCC;
        }
        #data>.wrapper>.report>.content .item>.self{
            height: 20px;
            background-color: #F6F6F6;
            border-bottom: 1px solid #BBB;
            position : relative;
        }
        #data>.wrapper>.report>.content .item>.self[data-report-warn=true]{
            background-color: #FFCCFF;
        }
        #data>.wrapper>.report>.content .item>.self>.value{
            position: absolute;
            top:2px;
            right:0;
            z-index:99;
        }
        #data>.wrapper>.report>.content .item>.self>.fold{
            width:16px;
            height: 16px;
            position: absolute;
            left:-17px;
            top:2px;
            background-color: #EEE;
            z-index:99;
            color: #AAA;
            font-weight:bolder;
            font-size: 16px;
            text-align:center;
        }
        #data>.wrapper>.report>.content .item>.self>.fold:hover{
            cursor:pointer;
        }
        #data>.wrapper>.report>.content .item>.self>.bar{
            height: 4px;
            position: absolute;
            right:0;
            z-index:98;
            top:16px;
        }
        #data>.wrapper>.report>.content .item>.subs[data-show=true]{
            display: block;
        }
        #data>.wrapper>.report>.content .item>.subs[data-show=false]{
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script type="module">
        import saulUtils from "../js/saul_utils.js";
        let ele = saulUtils.ele;
        let css = saulUtils.css;
        let getProp = saulUtils.getProp;

        let localOffset = new Date().getTimezoneOffset() * 60 * 1000;

        const { fetch: originalFetch } = window;
        window.fetch = async (...args) => {
            let [resource, config] = args;
            let response = await originalFetch(resource, config);
            if (!response.ok) {
                let msg = 'Error, code: '
                + response.headers.get("Error-Code")
                + ', message: '
                + response.headers.get("Error-Message");
                //                    弹窗显示错误
                return Promise.reject(msg);
            }
            return response;
        };

        function toFormatTime(timestamp) {
            let zoneOffset = 8;
            timestamp = Number(timestamp) + zoneOffset * 60 * 60 * 1000 + localOffset - 1;
            let time = new Date(timestamp);
            let timeFormat = time.getFullYear() + "-" + (time.getMonth() + 1) + "-" + time.getDate();
            return timeFormat;
        }

        function format(s) {
            let head = '';
            if(s.startsWith('-')){
                head = '-';
                s = s.substring(1);
            }
            let i = s.indexOf(".");
            let tail = '';
            if(i!==-1){
                tail = s.substring(i);
                s = s.substring(0,i);
            }
            let ss = s.split("");
            ss.reverse();
            let ss_ = [];
            let j = 0;
            for(let i = 0; i<ss.length;i++){
                if(j===3){
                    ss_.push(',');
                    j=0;
                }
                ss_.push(ss[i]);
                j++;
            }
            ss_.reverse();
            return head + ss_.join("") + tail;
        }

        document.addEventListener('DOMContentLoaded', e=>{
            let dataEle = document.querySelector("#data");
            let entityTypeSelectEle = document.querySelector('#select-entity-type');
            let dateTypeSelectEle = document.querySelector('#select-date-type');
            let companyCodeInputEle = document.querySelector('#company-code');
            let queryButtonEle = document.querySelector('#query');
            let itemData;
            let i18nData;
            let itemMaxWidth = 500;

            let itemMaxValue = 0.0;
            let dataHtmlMap = {};

            function feature(){
                for(let itemEle of dataEle.querySelectorAll(":scope>.wrapper>.report>.content .item")){
                    let subsEle = itemEle.querySelector(':scope>.subs');
                    if(subsEle){
                        subsEle.dataset.show = true;
                    }
                    let selfEle = itemEle.querySelector(':scope>.self');

                    let barEle = selfEle.querySelector(':scope>.bar');
                    let wd = itemMaxWidth * barEle.dataset.reportItemBar / itemMaxValue;
                    let color = wd < 0 ? 'red' : 'green';
                    css(barEle, {
                        width : Math.abs(wd)+ "px",
                        "background-color": color
                    });

                    let item = itemEle.dataset.reportItem;
                    let foldEle = selfEle.querySelector(':scope>.fold');
                    if(foldEle){
                        foldEle.innerHTML = '—';
                        foldEle.removeEventListener("click", foldEle.clickEventListener);
                        foldEle.clickEventListener = ()=>{
                            for(let itemEle_ of dataEle.querySelectorAll(":scope>.wrapper>.report>.content .item[data-report-item="+ item +"]")){
                                let subsEle_ = itemEle_.querySelector(':scope>.subs');
                                if(subsEle_){
                                    subsEle_.dataset.show = subsEle_.dataset.show === 'true' ? false: true;
                                    let foldEle = itemEle_.querySelector(':scope>.self>.fold');
                                    foldEle.innerHTML = foldEle.innerHTML === '+'? '—' : '+';
                                }
                            }
                        };
                        foldEle.addEventListener('click', foldEle.clickEventListener);
                    }
                }
            }

            function timePoint(timePointReport){
                let time = timePointReport.time;
                let titleEle = ele('div', {
                    class : "title"
                }, [document.createTextNode(toFormatTime(time))]);
                let contentEle = ele('div', {
                    class:"content"
                });
                let reportEle = ele('div',{
                    "data-report-time-type" : "timePoint",
                    "data-report-time" : time,
                    class : "report",
                    id: time
                }, [
                    titleEle,
                    contentEle
                ]);
                for(let i = 0;i< itemData.points.length;i++){
                    fillItem(timePointReport, i18nData.TimePointReport, titleEle, contentEle, itemData.points[i]);
                }
                return reportEle;
            }

            function timeRange(timeRangeReport){
                let et = timeRangeReport.entityType;
                let time = timeRangeReport.time;
                let titleEle = ele('div', {
                    class : "title"
                }, [document.createTextNode(toFormatTime(time))]);
                let contentEle = ele('div', {
                    class: "content"
                });
                let reportEle = ele('div', {
                    "data-report-time-type": "timeRange",
                    "data-report-time": time,
                    class : "report",
                    id: time
                }, [
                    titleEle,
                    contentEle
                ]);
                for(let i = 0;i< itemData.ranges.length;i++){
                    fillItem(timeRangeReport, i18nData.TimeRangeReport, titleEle, contentEle, itemData.ranges[i]);
                }

                if(et === '1'){
                    let chartEle = ele('div', {
                        class: 'chart'
                    });
                    css(chartEle, {
                        width: itemMaxWidth + "px",
                        height: "500px"
                    });
                    contentEle.appendChild(chartEle);
                    let wacc = timeRangeReport['pjjdcb'];
                    let leverage = timeRangeReport['pjrzgg'];
                    let lineChartData = [{
                        fieldName: 'shpjzyzbhbl',
                        color: '#FFCC99'
                    }, {
                        fieldName: 'sqpjzyzbhbl',
                        color: '#CD950C'
                    }, {
                        fieldName: 'kfshpjzyzbhbl',
                        color: '#9ACD32'
                    }, {
                        fieldName: 'kfsqpjzyzbhbl',
                        color: '#006400'
                    }, {
                        fieldName: 'shpjtrzbhbl',
                        color: '#BA55D3'
                    }, {
                        fieldName: 'sqpjtrzbhbl',
                        color: '#8A2BE2'
                    }, ];
                    let series = [];
                    let yMax = 0;
                    let xMax = 3;
                    let xInterval = (xMax-1)/10;
                    for(let it of lineChartData){
                        let data = [];
                        let y = timeRangeReport[it.fieldName];
                        for(let i = 1; i<= xMax+0.000001; i+=xInterval){
                            let y_ = (y - wacc/leverage + wacc/i) *100;
                            if(y_>yMax){
                                yMax = Math.ceil(y_);
                            }
                            data.push([i, y_]);
                        }
                        series.push({
                            name: i18nData.TimeRangeReport[it.fieldName],
                            data: data,
                            type: 'line'
                        });
                    }
                    console.log(series);

                    let option = {
                        //                        title: {
                        //                            text: '杠杆/回报率曲线',
                        //                            x: 'center'
                        //                        },
                        legend: {
                            orient: 'horizontal',
                            x: 'left',
                            y: 'top',
                            data: lineChartData.map(i => i18nData.TimeRangeReport[i.fieldName])
                        },
                        grid: {
                            top: '20%',
                            left: '3%',
                            right: '3%',
                            bottom: '5%',
                            containLabel: true
                        },
                        xAxis: {
                            name: '杠杆倍数(占用资本/净资产)',
                            type: 'value',
                            min:1,
                            max:xMax,
                            interval:xInterval
                        },
                        yAxis: {
                            name: '回报率%',
                            type: 'value',
                            min:0,
                            max:yMax,
                            interval:yMax/10
                        },
                        series: series,
                        color: lineChartData.map(i => i.color)
                    };
                    let lineChart = echarts.init(chartEle);
                    lineChart.setOption(option);
                }
                return reportEle;
            }

            function fillItem(report, i18n, titleEle, parentEle, item){
                let name = item.fieldName ? i18n[item.fieldName] : item.name;
                let wrapperEle = ele('div', {
                    "data-report-item" :name,
                    class:"item"
                });
                parentEle.appendChild(wrapperEle);
                let v;
                if(item.fieldName){
                    v = report[item.fieldName];
                }
                let v_ = v ? Math.abs(v) : 0;
                if(v_>itemMaxValue){
                    itemMaxValue = v_;
                }
                let selfEle = ele('div', {
                    class:"self"
                }, [
                    ele('div', {
                        class : "key"
                    }, [document.createTextNode(name)]),
                    ele('div', {
                        "data-report-item-bar": v,
                        class: "bar"
                    }),
                    ele('div', {
                        class: "value"
                    }, [document.createTextNode(v?format(v):'')])
                ]);
                if(item.fieldName === 'cwfyLxzc' || item.fieldName === 'cwfyLxsr'){
                    if(report.financialExpensesWarn){
                        selfEle.dataset.reportWarn = true;
                        titleEle.dataset.reportWarn = true;
                    }
                }
                if(item.fieldName === 'yylrwc'
                || item.fieldName === 'czhdxjlcxjwc'
                || item.fieldName === 'zczjwc'
                || item.fieldName === 'tzhdxjlrxjwc'){
                    if(report[item.fieldName] != "0"){
                        selfEle.dataset.reportWarn = true;
                        titleEle.dataset.reportWarn = true;
                    }
                }
                wrapperEle.appendChild(selfEle);
                if(item.subs){
                    selfEle.appendChild(ele('div', {class:"fold"}));
                    let subsEle = ele('div', {class:"subs"});
                    wrapperEle.appendChild(subsEle);
                    for(let i = 0; i< item.subs.length; i++){
                        fillItem(report, i18n, titleEle, subsEle, item.subs[i]);
                    }
                }
            }

            fetch('http://127.0.0.1:9001/finance/i18n/list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            }).then(response => {
                return response.json();
            }).then(json => {
                i18nData = {};
                for(let it of json){
                    let i18n = {};
                    for(let it_ of it.items){
                        i18n[it_.id] = it_.desc;
                    }
                    i18nData[it.name] = i18n;
                }
                console.log(i18nData);
            });

            fetch('http://127.0.0.1:9001/finance/company/itemTree', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            }).then(response => {
                return response.json();
            }).then(json => {
                itemData = json;
                queryButtonEle.removeAttribute('disabled');
                console.log(itemData);
            });

            function refresh(data){
                itemMaxValue = 0.0;
                dataHtmlMap = {};
                let t1 = {};
                t1.rs = data.timePointReports;
                t1.func = timePoint;
                let t2 = {};
                t2.rs = data.timeRangeReports;
                t2.func = timeRange;
                for(let t of new Array(t1,t2)){
                    for(let r of t.rs){
                        let wrapperEleMap = dataHtmlMap[r.entityType];
                        if(!wrapperEleMap){
                            wrapperEleMap = new Map();
                            dataHtmlMap[r.entityType] = wrapperEleMap;
                        }
                        let wrapperEle = wrapperEleMap.get(r.time);
                        if(!wrapperEle){
                            wrapperEle = ele('div',{
                                "data-report-time" : r.time,
                                class:"wrapper"
                            });
                            wrapperEleMap.set(r.time, wrapperEle);
                        }
                        wrapperEle.appendChild(t.func(r));
                    }
                }
                render(entityTypeSelectEle.value);
            }

            function render(entityType){
                let rs = dataHtmlMap[entityType];
                if(!rs){
                    return;
                }
                dataEle.innerHTML = '';
                for(let r of rs.values()){
                    dataEle.appendChild(r);
                }
                feature();
            }

            queryButtonEle.addEventListener('click', function() {
                let code = companyCodeInputEle.value.trim();
                if(code === ''){
                    return;
                }
                fetch('http://127.0.0.1:9001/finance/company/detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: code,
                        dateType: dateTypeSelectEle.value
                    }),
                }).then(response => {
                    return response.json();
                }).then(json=>{
                    refresh(json);
                });
            });

            entityTypeSelectEle.addEventListener('change', function() {
                render(entityTypeSelectEle.value);
            });
        });

    </script>


</head>
<body>

<div id="app">
    <div id="form">
        <div>
            <input id="company-code"/>
            <select id="select-date-type">
                <option value="4" selected="selected">年报</option>
                <option value="1">一季报</option>
                <option value="2">半年报</option>
                <option value="3">三季报</option>
            </select>
            <button id="query" type="button" disabled="true">查询</button>

            <select id="select-entity-type">
                <option value="1" selected="selected">合并</option>
                <option value="2">归母</option>
                <option value="4">少数股东</option>
            </select>
        </div>
    </div>
    <div id="data">

    </div>
</div>
</body>
</html>